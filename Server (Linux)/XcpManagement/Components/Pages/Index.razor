@page "/"
@rendermode InteractiveServer
@inject IVmCacheService VmCache
@inject IXcpHostService HostService

<PageHeader Title="Dashboard" />

<Row Gutter="16">
    <AntDesign.Col Span="6">
        <Card>
            <Statistic Title="Total Hosts" Value="@totalHosts">
                <PrefixTemplate><Icon Type="cluster" Theme="outline" /></PrefixTemplate>
            </Statistic>
        </Card>
    </AntDesign.Col>
    <AntDesign.Col Span="6">
        <Card>
            <Statistic Title="Total VMs" Value="@totalVms" ValueStyle="color: #3f8600;">
                <PrefixTemplate><Icon Type="desktop" Theme="outline" /></PrefixTemplate>
            </Statistic>
        </Card>
    </AntDesign.Col>
    <AntDesign.Col Span="6">
        <Card>
            <Statistic Title="Running" Value="@runningVms" ValueStyle="color: #52c41a;">
                <PrefixTemplate><Icon Type="check-circle" Theme="outline" /></PrefixTemplate>
            </Statistic>
        </Card>
    </AntDesign.Col>
    <AntDesign.Col Span="6">
        <Card>
            <Statistic Title="Stopped" Value="@stoppedVms" ValueStyle="color: #ff4d4f;">
                <PrefixTemplate><Icon Type="close-circle" Theme="outline" /></PrefixTemplate>
            </Statistic>
        </Card>
    </AntDesign.Col>
</Row>

<Card Title="Virtual Machines by Host" Style="margin-top: 24px;">
    <Table TItem="HostSummary" DataSource="@hostSummaries" Loading="@loading">
        <Column Title="Host" @bind-Field="@context.HostName" />
        <Column Title="Total VMs" @bind-Field="@context.TotalVms" />
        <Column Title="Running" @bind-Field="@context.RunningVms">
            <Badge Status="success" Text="@context.RunningVms.ToString()" />
        </Column>
        <Column Title="Stopped" @bind-Field="@context.StoppedVms">
            <Badge Status="error" Text="@context.StoppedVms.ToString()" />
        </Column>
        <Column Title="Memory">
            @($"{context.MemoryGB:F1} GB")
        </Column>
    </Table>
</Card>

@code {
    private int totalHosts;
    private int totalVms;
    private int runningVms;
    private int stoppedVms;
    private bool loading = true;
    private List<HostSummary> hostSummaries = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        loading = true;
        
        var hosts = await HostService.GetAllHostsAsync();
        totalHosts = hosts.Count;

        var allVms = VmCache.GetAllVirtualMachines();
        totalVms = allVms.Count;
        runningVms = allVms.Count(vm => vm.PowerState == VmPowerState.Running);
        stoppedVms = allVms.Count(vm => vm.PowerState == VmPowerState.Halted);

        hostSummaries = hosts.Select(host =>
        {
            var hostVms = allVms.Where(vm => vm.HostId == host.HostId).ToList();
            return new HostSummary
            {
                HostName = host.HostName,
                TotalVms = hostVms.Count,
                RunningVms = hostVms.Count(vm => vm.PowerState == VmPowerState.Running),
                StoppedVms = hostVms.Count(vm => vm.PowerState == VmPowerState.Halted),
                MemoryGB = hostVms.Sum(vm => vm.MemoryDynamic) / (1024.0 * 1024 * 1024)
            };
        }).ToList();

        loading = false;
    }

    public class HostSummary
    {
        public string HostName { get; set; } = "";
        public int TotalVms { get; set; }
        public int RunningVms { get; set; }
        public int StoppedVms { get; set; }
        public double MemoryGB { get; set; }
    }
}
